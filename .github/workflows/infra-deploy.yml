name: terraform AWS deployment
run-name: ${{ inputs.action }} ${{ inputs.module }}

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Terraform Module to Deploy'
        required: true
        default: all
        type: choice
        options:
          - all
          - vpc
          - sg
          - ec2
          - alb
          - rds
          
      action:
        description: 'Terraform Action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
env:
    ACTION: ${{ github.event.inputs.action || 'plan' }}
    MODULE: ${{ github.event.inputs.module || 'all' }}
    WORKING_DIR: terraform
    TF_VERSION: 1.13.0

permissions:
  contents: read
  pull-requests: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Init
        run: terraform init
      
      - name: Check and unlock Terraform state (if locked)
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ lock —Ñ–∞–π–ª–∞ –≤ S3
          if aws s3 ls s3://artyriolabs/terraform.tfstate.lock --region eu-central-1 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: Terraform state is locked!"
            echo "‚ö†Ô∏è  This usually means a previous terraform apply is still running or failed."
            echo "‚ö†Ô∏è  Removing stale lock file..."
            echo "‚ö†Ô∏è  If a terraform apply is currently running, this may cause issues!"
            aws s3 rm s3://artyriolabs/terraform.tfstate.lock --region eu-central-1
            echo "‚úÖ Lock file removed. Proceeding..."
          else
            echo "‚úÖ No state lock found"
          fi
        continue-on-error: true
      
      - name: Remove old HTTP listener from state (if exists and enable_https=true)
        run: |
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π HTTP listener –∏–∑ state, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
          # –≠—Ç–æ –Ω—É–∂–Ω–æ, –µ—Å–ª–∏ listener –±—ã–ª —É–¥–∞–ª–µ–Ω –≤—Ä—É—á–Ω—É—é, –Ω–æ –æ—Å—Ç–∞–ª—Å—è –≤ state
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ enable_https=true –≤ terraform.tfvars
          if grep -q "enable_https.*=.*true" terraform.tfvars 2>/dev/null; then
            echo "üîç enable_https=true detected, checking for old HTTP listener in state..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ listener –≤ state
            if terraform state list 2>/dev/null | grep -q "module.alb.aws_lb_listener.http$"; then
              echo "‚ö†Ô∏è  Found old HTTP listener in state, removing..."
              terraform state rm 'module.alb.aws_lb_listener.http' && echo "‚úÖ HTTP listener removed from state" || echo "‚ùå Failed to remove HTTP listener"
            else
              echo "‚ÑπÔ∏è  HTTP listener not in state (already removed or never existed)"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ listener rule –≤ state
            if terraform state list 2>/dev/null | grep -q "module.alb.aws_lb_listener_rule.http_api_forward$"; then
              echo "‚ö†Ô∏è  Found old HTTP listener rule in state, removing..."
              terraform state rm 'module.alb.aws_lb_listener_rule.http_api_forward' && echo "‚úÖ HTTP listener rule removed from state" || echo "‚ùå Failed to remove HTTP listener rule"
            else
              echo "‚ÑπÔ∏è  HTTP listener rule not in state (already removed or never existed)"
            fi
          else
            echo "‚ÑπÔ∏è  enable_https is not true, skipping HTTP listener removal"
          fi
        continue-on-error: true
      
      - name: Terraform Action (${{ env.ACTION }})
        run: |
          case "${MODULE}" in
            vpc) TARGET="-target=module.vpc" ;;
            sg)  TARGET="-target=module.security_groups" ;;
            ec2) TARGET="-target=module.ec2" ;;
            alb) TARGET="-target=module.alb" ;;
            rds) TARGET="-target=module.rds" ;;
            all) TARGET="" ;;
          esac

          case "${ACTION}" in
            plan)
              terraform plan -no-color -out=tfplan $TARGET
              ;;
            apply)
              terraform plan -no-color -out=tfplan $TARGET
              terraform apply -auto-approve tfplan 
              ;;
            destroy)
              terraform destroy -auto-approve $TARGET
              ;;
          esac
        shell: bash

  build-and-push:
    if: ${{ github.event.inputs.module == 'all' && github.event.inputs.action == 'apply' }}
    needs: terraform
    uses: ./.github/workflows/auto-build-and-push.yml
    secrets: inherit

  deploy:
    if: ${{ github.event.inputs.module == 'all' && github.event.inputs.action == 'apply' }}
    needs: [build-and-push, terraform]
    uses: ./.github/workflows/auto-deploy.yml
    with:
      tag: latest
    secrets: inherit